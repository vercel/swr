import { Callout } from 'nextra-theme-docs'
import Link from 'next/link'

# é”™è¯¯å¤„ç†

å¦‚æœåœ¨ [`fetcher`](/docs/data-fetching) ä¸­æŠ›å‡ºé”™è¯¯ï¼Œhook ä¼šå°†å…¶ä½œä¸º `error` è¿”å›ã€‚

```js
const fetcher = url => fetch(url).then(r => r.json())

// ...
const { data, error } = useSWR('/api/user', fetcher)
```

å¦‚æœ fetch promise è¢«æ‹’ç»ï¼Œå°†å®šä¹‰ `error` å¯¹è±¡ã€‚

## çŠ¶æ€ç å’Œé”™è¯¯å¯¹è±¡ [#status-code-and-error-object]

æœ‰æ—¶æˆ‘ä»¬å¸Œæœ› API åœ¨è¿”å›çŠ¶æ€ç çš„åŒæ—¶è¿”å›ä¸€ä¸ªé”™è¯¯å¯¹è±¡ã€‚å®ƒä»¬å¯¹å®¢æˆ·ç«¯éƒ½æ˜¯æœ‰ç”¨çš„ã€‚

æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ `fetcher` ä»¥è¿”å›æ›´å¤šä¿¡æ¯ã€‚å¦‚æœçŠ¶æ€ç ä¸æ˜¯ `2xx`ï¼Œæˆ‘ä»¬åˆ™è®¤ä¸ºå®ƒæ˜¯ä¸€ä¸ªé”™è¯¯ï¼Œå³ä½¿å®ƒå¯ä»¥è¢«è§£æä¸º JSONï¼š

```js
const fetcher = async url => {
  const res = await fetch(url)

  // å¦‚æœçŠ¶æ€ç ä¸åœ¨ 200-299 çš„èŒƒå›´å†…ï¼Œ
  // æˆ‘ä»¬ä»ç„¶å°è¯•è§£æå¹¶æŠ›å‡ºå®ƒã€‚
  if (!res.ok) {
    const error = new Error('An error occurred while fetching the data.')
    // å°†é¢å¤–çš„ä¿¡æ¯é™„åŠ åˆ°é”™è¯¯å¯¹è±¡ä¸Šã€‚
    error.info = await res.json()
    error.status = res.status
    throw error
  }

  return res.json()
}

// ...
const { data, error } = useSWR('/api/user', fetcher)
// error.info === {
//   message: "You are not authorized to access this resource.",
//   documentation_url: "..."
// }
// error.status === 403
```

<Callout emoji="ğŸ’¡">
  æ³¨æ„ï¼š<code>data</code> å’Œ <code>error</code> å¯ä»¥åŒæ—¶å­˜åœ¨ã€‚æ‰€ä»¥ UI å¯ä»¥åœ¨çŸ¥é“å³å°†åˆ°æ¥çš„è¯·æ±‚å¤±è´¥æ—¶æ˜¾ç¤ºç°æœ‰æ•°æ®ã€‚
</Callout>

[è¿™é‡Œ](/examples/error-handling)æœ‰ä¸€ä¸ªç¤ºä¾‹ã€‚

## é”™è¯¯é‡è¯• [#error-retry]

åœ¨å‡ºç°é”™è¯¯æ—¶ SWR ä½¿ç”¨[æŒ‡æ•°é€€é¿ç®—æ³•](https://en.wikipedia.org/wiki/Exponential_backoff)é‡å‘è¯·æ±‚ã€‚è¯¥ç®—æ³•å…è®¸åº”ç”¨ä»é”™è¯¯ä¸­å¿«é€Ÿæ¢å¤ï¼Œè€Œä¸ä¼šæµªè´¹èµ„æºé¢‘ç¹åœ°é‡è¯•ã€‚

ä½ è¿˜å¯ä»¥é€šè¿‡ [onErrorRetry](/docs/api#options) é€‰é¡¹è¦†ç›–è¯¥è¡Œä¸ºï¼š

```js
useSWR('/api/user', fetcher, {
  onErrorRetry: (error, key, config, revalidate, { retryCount }) => {
    // 404 æ—¶ä¸é‡è¯•ã€‚
    if (error.status === 404) return

    // ç‰¹å®šçš„ key æ—¶ä¸é‡è¯•ã€‚
    if (key === '/api/user') return

    // æœ€å¤šé‡è¯• 10 æ¬¡ã€‚
    if (retryCount >= 10) return

    // 5ç§’åé‡è¯•ã€‚
    setTimeout(() => revalidate({ retryCount: retryCount }), 5000)
  }
})
```

è¿™ä¸ªå›è°ƒè®©ä½ å¯ä»¥çµæ´»çš„æ ¹æ®å„ç§æ¡ä»¶é‡è¯•ã€‚ä½ ä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½® `shouldRetryOnError: false` æ¥ç¦ç”¨å®ƒã€‚

ä¹Ÿå¯ä»¥é€šè¿‡[å…¨å±€é…ç½®](/docs/global-configuration) context æ¥æä¾›å®ƒã€‚

## å…¨å±€é”™è¯¯æŠ¥å‘Š [#global-error-report]

ä½ æ€»æ˜¯å¯ä»¥å“åº”æ€§çš„åœ¨ç»„ä»¶å†…éƒ¨å¾—åˆ° `error` å¯¹è±¡ã€‚ä½†å¦‚æœä½ æƒ³è¦å…¨å±€å¤„ç†é”™è¯¯ï¼Œé€šçŸ¥ UI æ˜¾ç¤ºä¸€ä¸ª [toast](https://vercel.com/design/toast) æˆ–è€…ä¸€ä¸ª [snackbar](https://material.io/components/snackbars)ï¼Œæˆ–åœ¨æŸå¤„æŠ¥å‘Šå®ƒï¼Œæ¯”å¦‚ [Sentry](https://sentry.io)ï¼Œå¯ä»¥ç”¨ [`onError`](/docs/api#options) äº‹ä»¶ï¼š

```jsx
<SWRConfig value={{
  onError: (error, key) => {
    if (error.status !== 403 && error.status !== 404) {
      // æˆ‘ä»¬å¯ä»¥æŠŠé”™è¯¯å‘é€ç»™ Sentryï¼Œ
      // æˆ–æ˜¾ç¤ºä¸€ä¸ªé€šçŸ¥ UIã€‚
    }
  }
}}>
  <MyApp />
</SWRConfig>
```
