import { Callout } from 'nextra-theme-docs'

# ç¼“å­˜

<Callout>
  å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ï¼ˆâ‰¥ 1.0.0ï¼‰æ¥ä½¿ç”¨è¯¥åŠŸèƒ½ã€‚
</Callout>

<Callout emoji="âš ï¸">
  åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ ä¸åº”è¯¥ç›´æ¥*å†™å…¥*ç¼“å­˜ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´ SWR ä¸å¯é¢„çŸ¥çš„è¡Œä¸ºã€‚å¦‚æœä½ éœ€è¦æ‰‹åŠ¨æ“ä½œä¸€ä¸ª keyï¼Œè¯·è€ƒè™‘ä½¿ç”¨ SWR APIã€‚<br/>
  å‚è§ï¼š[æ•°æ®æ›´æ”¹](/docs/mutation)ï¼Œ[é‡ç½®æµ‹è¯•ç”¨ä¾‹ä¹‹é—´çš„ç¼“å­˜](#reset-cache-between-test-cases)ã€‚
</Callout>

é»˜è®¤æƒ…å†µä¸‹ï¼ŒSWR ä½¿ç”¨å…¨å±€ç¼“å­˜åœ¨æ‰€æœ‰ç»„ä»¶ä¹‹é—´å­˜å‚¨å’Œå…±äº«æ•°æ®ã€‚ä½†ä½ ä¹Ÿå¯ä»¥é€šè¿‡ `SWRConfig` çš„ `provider` é€‰é¡¹æ¥è‡ªå®šä¹‰è¿™ä¸ªè¡Œä¸ºã€‚

ç¼“å­˜ provider æ—¨åœ¨é€šè¿‡æ›´å¤šè‡ªå®šä¹‰å­˜å‚¨å¯ç”¨ SWRã€‚

## ç¼“å­˜ Provider [#cache-provider]

ç¼“å­˜ provider æ˜¯ç±»ä¼¼ Map çš„å¯¹è±¡ï¼Œå®ƒåŒ¹é…ä»¥ä¸‹ TypeScript å®šä¹‰ï¼ˆå¯ä»¥ä» `swr` å¯¼å…¥ï¼‰ï¼š

```typescript
interface Cache<Data> {
  get(key: string): Data | undefined
  set(key: string, value: Data): void
  delete(key: string): void
  keys(): IterableIterator<string>
}
```

ä¾‹å¦‚ï¼Œä¸€ä¸ª [JavaScript Map](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map) å®ä¾‹å¯ä»¥ç›´æ¥ç”¨ä½œ SWR çš„ç¼“å­˜ providerã€‚

## åˆ›å»ºç¼“å­˜ Provider [#create-cache-provider]

`SWRConfig` çš„ `provider` é€‰é¡¹æ¥æ”¶ä¸€ä¸ªè¿”å›[ç¼“å­˜ provider](#cache-provider) çš„å‡½æ•°ã€‚è¯¥ provider å°†è¢« `SWRConfig` èŒƒå›´å†…çš„æ‰€æœ‰ SWR hook ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼š

```jsx
import useSWR, { SWRConfig } from 'swr'

function App() {
  return (
    <SWRConfig value={{ provider: () => new Map() }}>
      <Page/>
    </SWRConfig>
  )
}
```

`<Page/>` ä¸­çš„æ‰€æœ‰ SWR hook éƒ½å°†ä»è¯¥ Map å®ä¾‹è¯»å–å’Œå†™å…¥ã€‚ä½ è¿˜å¯ä»¥é’ˆå¯¹ä½ çš„ç‰¹å®šç”¨ä¾‹ä½¿ç”¨å…¶ä»–ç¼“å­˜ provider å®ç°ã€‚

<Callout>
  åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå½“ `<App/>` ç»„ä»¶é‡æ–°æŒ‚è½½æ—¶ï¼Œprovider ä¹Ÿä¼šè¢«é‡æ–°åˆ›å»ºã€‚ç¼“å­˜ provider åº”è¯¥æ”¾åœ¨ç»„ä»¶æ ‘çš„æ›´é«˜ä½ç½®ï¼Œæˆ–è€…æ”¾åœ¨æ¸²æŸ“ä¹‹å¤–ã€‚
</Callout>

import { Cache } from 'components/diagrams/cache'

<div className="my-8">
  <Cache/>
</div>

å½“åµŒå¥—æ—¶ï¼ŒSWR hook å°†ä½¿ç”¨ä¸Šå±‚ç¼“å­˜ providerã€‚å¦‚æœæ²¡æœ‰ä¸Šå±‚ç¼“å­˜ providerï¼Œåˆ™å›é€€åˆ°é»˜è®¤ providerï¼Œå³ä¸€ä¸ªç©º `Map`ã€‚

<Callout emoji="âš ï¸">
   å¦‚æœä½¿ç”¨äº†ç¼“å­˜ providerï¼Œåˆ™å…¨å±€ `mutate` å°†**ä¸**é€‚ç”¨äº `<SWRConfig>` èŒƒå›´å†…çš„ SWR hookã€‚è¯·ä½¿ç”¨[è®¿é—®å½“å‰ç¼“å­˜ Provider](#access-current-cache-provider) ä»£æ›¿ã€‚
</Callout>

## è®¿é—®å½“å‰ç¼“å­˜ Provider [#access-current-cache-provider]

åœ¨ React ç»„ä»¶å†…éƒ¨ï¼Œä½ éœ€è¦ä½¿ç”¨ [`useSWRConfig`](/docs/global-configuration#access-to-global-configurations) hook æ¥è®¿é—®å½“å‰ç¼“å­˜ provider ä»¥åŠå…¶ä»–é…ç½®ï¼ŒåŒ…æ‹¬ `mutate`ï¼š

```jsx
import { useSWRConfig } from 'swr'

function Avatar() {
  const { cache, mutate, ...extraConfig } = useSWRConfig()
  // ...
}
```

å¦‚æœä¸åœ¨ä»»ä½• `<SWRConfig>` ä¸­ï¼Œå°†è¿”å›é»˜è®¤é…ç½®ã€‚

## å®éªŒæ€§ï¼šæ‰©å±•ç¼“å­˜ provider [#experimental-extend-cache-provider]

<Callout emoji="ğŸ§ª">
   è¿™æ˜¯ä¸€ä¸ªå®éªŒæ€§çš„åŠŸèƒ½ï¼Œåœ¨æœªæ¥çš„å‡çº§ä¸­å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚
</Callout>

å½“å¤šä¸ª `<SWRConfig>` ç»„ä»¶åµŒå¥—æ—¶ï¼Œå¯ä»¥æ‰©å±•ç¼“å­˜ providerã€‚

`provider` å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸Šå±‚ `<SWRConfig>` çš„ç¼“å­˜ providerï¼ˆå¦‚æœæ²¡æœ‰çˆ¶çº§ `<SWRConfig>`ï¼Œåˆ™ä¸ºé»˜è®¤ç¼“å­˜ï¼‰ï¼Œä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥æ‰©å±•ç¼“å­˜ providerï¼š

```jsx
<SWRConfig value={{ provider: (cache) => newCache }}>
  ...
</SWRConfig>
```

## ç¤ºä¾‹ [#examples]

### åŸºäº LocalStorage çš„æŒä¹…ç¼“å­˜ [#localstorage-based-persistent-cache]

ä½ å¯èƒ½å¸Œæœ›å°†ç¼“å­˜åŒæ­¥åˆ° `localStorage`ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹å®ç°ï¼š

```jsx
function localStorageProvider() {
  // åˆå§‹åŒ–æ—¶ï¼Œæˆ‘ä»¬å°†æ•°æ®ä» `localStorage` æ¢å¤åˆ°ä¸€ä¸ª map ä¸­ã€‚
  const map = new Map(JSON.parse(localStorage.getItem('app-cache') || '[]'))

  // åœ¨å¸è½½ app ä¹‹å‰ï¼Œæˆ‘ä»¬å°†æ‰€æœ‰æ•°æ®å†™å› `localStorage` ä¸­ã€‚
  window.addEventListener('beforeunload', () => {
    const appCache = JSON.stringify(Array.from(map.entries()))
    localStorage.setItem('app-cache', appCache)
  })

  // æˆ‘ä»¬ä»ç„¶ä½¿ç”¨ map è¿›è¡Œè¯»å†™ä»¥æé«˜æ€§èƒ½ã€‚
  return map
}
```

ç„¶åå°†å…¶ä½œä¸º provider ä½¿ç”¨ï¼š

```jsx
<SWRConfig value={{ provider: localStorageProvider }}>
  <App/>
</SWRConfig>
```

<Callout>
  ä½œä¸ºä¸€ç§æ”¹è¿›ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨å†…å­˜ç¼“å­˜ä½œä¸ºç¼“å†²åŒºï¼Œå¹¶å®šæœŸå†™å…¥ `localStorage`ã€‚ä½ è¿˜å¯ä»¥ä½¿ç”¨ IndexedDB æˆ– WebSQL å®ç°ç±»ä¼¼çš„åˆ†å±‚ç¼“å­˜ã€‚
</Callout>

### é‡ç½®æµ‹è¯•ç”¨ä¾‹ä¹‹é—´çš„ç¼“å­˜ [#reset-cache-between-test-cases]

åœ¨æµ‹è¯•åº”ç”¨ç¨‹åºæ—¶ï¼Œä½ å¯èƒ½å¸Œæœ›é‡ç½®æµ‹è¯•ç”¨ä¾‹ä¹‹é—´çš„ SWR ç¼“å­˜ã€‚ä½ å¯ä»¥ç®€å•åœ°ä½¿ç”¨ç©ºç¼“å­˜ provider åŒ…è£…ä½ çš„åº”ç”¨ç¨‹åºã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ Jest çš„ä¾‹å­ï¼š

```jsx
describe('test suite', async () => {
  it('test case', async () => {
    render(
      <SWRConfig value={{ provider: () => new Map() }}>
        <App/>
      </SWRConfig>
    )
  })
})
```

### Modify the Cache Data [#modify-the-cache-data]

<Callout emoji="ğŸš¨" type="error">
  ä½ ä¸åº”è¯¥ç›´æ¥å†™å…¥ç¼“å­˜ï¼Œé‚£æ ·å¯èƒ½ä¼šå¯¼è‡´ä¸å¯é¢„çŸ¥çš„è¡Œä¸ºã€‚
</Callout>

You can use [`mutate`](/docs/mutation) to modify the cache. For example, you can clear all cache data like the following.

```jsx
const { mutate } = useSWRConfig()

mutate(
  key => true, // which cache keys are updated
  undefined, // update cache data to `undefined`
  { revalidate: false } // do not revalidate
)
```

More information can be found [here](/docs/arguments#multiple-arguments).
